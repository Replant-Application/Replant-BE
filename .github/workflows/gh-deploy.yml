name: Build, Test, Scan, and Deploy Web with Docker + SonarCloud + Snyk + Trivy + ZAP

on:
  push:
    branches: ["main"]

# 같은 브랜치에서 중복 실행 방지
concurrency:
  group: web-ci-cd-${{ github.ref }}
  cancel-in-progress: true

# 최소 권한 (필요 시 job 단위로 추가)
permissions:
  contents: read

env:
  IMAGE_NAME: your-image-name
  REGISTRY: docker.io
  IMAGE_TAG: ${{ github.sha }}

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run tests
        run: ./gradlew test

  snyk_scan:
    name: Run Snyk SCA Scan (gate)
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew build -x test

      # 취약점 있으면 실패하도록 test 사용 (게이트)
      - name: Run Snyk test (fail on HIGH+)
        uses: snyk/actions/gradle@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: test
          args: --severity-threshold=high

      # (선택) 결과를 Snyk 대시보드에 업로드
      - name: Run Snyk monitor (optional)
        if: always()
        uses: snyk/actions/gradle@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: monitor

  sonarcloud_scan:
    name: Run SonarCloud SAST Scan (gate)
    needs: snyk_scan
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew build -x test

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v3
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
            -Dsonar.organization=${{ secrets.SONAR_ORG }}
            -Dsonar.projectName=${{ secrets.SONAR_PROJECT_NAME }}
            -Dsonar.sources=src
            -Dsonar.java.binaries=build/classes
            -Dsonar.host.url=https://sonarcloud.io

      # (선택) "품질게이트"를 확실히 job fail로 반영하고 싶으면 아래를 추가 고려
      # - SonarCloud 프로젝트에서 Quality Gate가 브랜치에 강제되도록 설정하는 게 일반적입니다.

  docker_build_and_push:
    name: Build and Push Docker Image
    needs: sonarcloud_scan
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build JAR with Gradle
        run: ./gradlew clean bootJar -x test

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }} # 권장: Docker Hub Access Token

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
            ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  trivy_scan:
    name: Run Trivy Image Scan (gate + report)
    needs: docker_build_and_push
    runs-on: ubuntu-latest
    steps:
      - name: Set image reference
        id: set-image-ref
        run: |
          echo "IMAGE_REF=${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}" >> $GITHUB_ENV

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Pull image
        run: docker pull "${IMAGE_REF}"

      # 템플릿은 가능하면 repo에 고정(vendoring) 추천
      # 예: .trivy/html.tpl 파일을 커밋해두고 curl 단계 제거
      - name: Download Trivy HTML Template
        run: |
          mkdir -p .trivy
          curl -sSfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/html.tpl -o .trivy/html.tpl

      - name: Trivy report (HTML)
        uses: aquasecurity/trivy-action@0.28.0
        env:
          IMAGE_REF: ${{ env.IMAGE_REF }}
        with:
          image-ref: ${{ env.IMAGE_REF }}
          format: template
          template: "@.trivy/html.tpl"
          output: trivy-report.html
          exit-code: "0"
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH"

      - name: Upload Trivy Report as Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report
          path: trivy-report.html

      - name: Trivy gate (fail on CRITICAL/HIGH)
        uses: aquasecurity/trivy-action@0.28.0
        env:
          IMAGE_REF: ${{ env.IMAGE_REF }}
        with:
          image-ref: ${{ env.IMAGE_REF }}
          format: table
          exit-code: "1"
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH"

      - name: Show Report Summary
        if: always()
        run: |
          echo "## Trivy Scan Report" >> "$GITHUB_STEP_SUMMARY"
          echo "Artifact로 trivy-report.html 업로드 완료" >> "$GITHUB_STEP_SUMMARY"
          echo "- Image: $IMAGE_REF" >> "$GITHUB_STEP_SUMMARY"

  deploy:
    name: Deploy to EC2 (Docker Run)
    needs: trivy_scan
    runs-on: ubuntu-latest
    steps:
      - name: Set environment variables
        run: |
          echo "IMAGE_REF=${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}" >> $GITHUB_ENV
          echo "CONTAINER_NAME=${{ env.IMAGE_NAME }}" >> $GITHUB_ENV
      - name: Set up SSH Key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > /tmp/id_rsa
          chmod 600 /tmp/id_rsa

      # ✅ 중요: heredoc를 single-quote로 막지 말고, 필요한 값은 env로 전달
      - name: Deploy via SSH
        env:
          EC2_HOST: ${{ secrets.EC2_PUBLIC_IP }}
          EC2_USER: ${{ secrets.EC2_SSH_USER }} # 예: ec2-user 또는 ubuntu
          DOCKER_USER: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASS: ${{ secrets.DOCKER_PASSWORD }}
          IMAGE_REF: ${{ env.IMAGE_REF }}
          CONTAINER_NAME: ${{ env.CONTAINER_NAME }}
        run: |
          ssh -o StrictHostKeyChecking=no -i /tmp/id_rsa ${EC2_USER}@${EC2_HOST} \
          "IMAGE_REF='${IMAGE_REF}' CONTAINER_NAME='${CONTAINER_NAME}' DOCKER_USER='${DOCKER_USER}' DOCKER_PASS='${DOCKER_PASS}' bash -s" << EOF
            set -euo pipefail

            # Docker 없으면 설치(최소)
            if ! command -v docker >/dev/null 2>&1; then
              if command -v yum >/dev/null 2>&1; then
                sudo yum -y install docker || (sudo amazon-linux-extras install docker -y)
                sudo systemctl enable docker
                sudo systemctl start docker
              elif command -v apt-get >/dev/null 2>&1; then
                sudo apt-get update -y
                sudo apt-get install -y docker.io
                sudo systemctl enable docker
                sudo systemctl start docker
              fi
            fi

            sudo systemctl start docker || sudo service docker start || true

            echo "\${DOCKER_PASS}" | sudo docker login -u "\${DOCKER_USER}" --password-stdin

            sudo docker pull "\${IMAGE_REF}"

            sudo docker stop "\${CONTAINER_NAME}" 2>/dev/null || true
            sudo docker rm "\${CONTAINER_NAME}" 2>/dev/null || true

            # 필요하면 환경변수/볼륨/네트워크 추가
            sudo docker run -d \
              -p 8080:8080 \
              --restart unless-stopped \
              --name "\${CONTAINER_NAME}" \
              "\${IMAGE_REF}"

            sudo docker image prune -f
          EOF

  zap_scan:
    name: DAST with OWASP ZAP (report)
    needs: deploy
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write # ZAP이 이슈/코멘트 남길 때 필요. 필요 없으면 지워도 됨.
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ✅ 배포 직후 앱 준비 대기(자주 실패하는 부분 방지)
      - name: Wait for service to be ready
        env:
          TARGET: ${{ secrets.DEPLOY_TARGET_URL }} # 예: http://1.2.3.4/
        run: |
          set -euo pipefail
          echo "Waiting for: ${TARGET}"
          for i in {1..60}; do
            code="$(curl -s -o /dev/null -w "%{http_code}" "${TARGET}" || true)"
            if [ "$code" = "200" ] || [ "$code" = "301" ] || [ "$code" = "302" ]; then
              echo "Service is up (HTTP $code)"
              exit 0
            fi
            sleep 5
          done
          echo "Service did not become ready in time."
          exit 1

      - name: ZAP Full Scan
        uses: zaproxy/action-full-scan@v0.12.0
        with:
          # 보통은 GitHub 토큰이면 충분 (PAT 과권한 방지)
          token: ${{ github.token }}
          docker_name: ghcr.io/zaproxy/zaproxy:stable
          target: ${{ secrets.DEPLOY_TARGET_URL }}
          rules_file_name: .zap/rules.tsv
          cmd_options: "-a"

      - name: Upload ZAP Report(s)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: |
            report_html.html
            report_json.json
            report_md.md
