name: Build, Test, Scan, and Deploy Web with Docker + SonarCloud + Snyk + Trivy + ZAP

on:
  push:
    branches: ["main"]

# ê°™ì€ ë¸Œëœì¹˜ì—ì„œ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
concurrency:
  group: web-ci-cd-${{ github.ref }}
  cancel-in-progress: true

# ìµœì†Œ ê¶Œí•œ (í•„ìš” ì‹œ job ë‹¨ìœ„ë¡œ ì¶”ê°€)
permissions:
  contents: read

env:
  IMAGE_NAME: your-image-name
  REGISTRY: docker.io
  IMAGE_TAG: ${{ github.sha }}

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Create .env from secrets
        run: |
          echo "DB1_URL=${{ secrets.DB1_URL }}" >> .env
          echo "DB1_USERNAME=${{ secrets.DB1_USERNAME }}" >> .env
          echo "DB1_PASSWORD=${{ secrets.DB1_PASSWORD }}" >> .env
          echo "REDIS_URL=${{ secrets.REDIS_URL }}" >> .env
          echo "REDIS_PORT=${{ secrets.REDIS_PORT }}" >> .env
          echo "REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}" >> .env
          echo "JWT=${{ secrets.JWT }}" >> .env
          echo "S3_BUCKET=${{ secrets.S3_BUCKET }}" >> .env
          echo "S3_ACCESS_KEY=${{ secrets.S3_ACCESS_KEY }}" >> .env
          echo "S3_SECRET_KEY=${{ secrets.S3_SECRET_KEY }}" >> .env
          echo "S3_CLIENT=${{ secrets.S3_CLIENT }}" >> .env
          echo "S3_REGION=${{ secrets.S3_REGION }}" >> .env
          echo "GOOGLE_MAIL=${{ secrets.GOOGLE_MAIL }}" >> .env
          echo "GOOGLE_APP_PASSWORD=${{ secrets.GOOGLE_APP_PASSWORD }}" >> .env
          echo "FRONTEND_URL=${{ secrets.FRONTEND_URL }}" >> .env

      - name: Run tests
        run: ./gradlew test

  snyk_scan:
    name: Run Snyk SCA Scan (gate)
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        id: setup-java
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew build -x test

      - name: Install Snyk CLI
        run: |
          npm install -g snyk

      # ì·¨ì•½ì  ìˆìœ¼ë©´ ì‹¤íŒ¨í•˜ë„ë¡ test ì‚¬ìš© (ê²Œì´íŠ¸)
      - name: Run Snyk test (fail on HIGH+)
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          snyk test --severity-threshold=high --all-projects || true
          snyk test --severity-threshold=high --all-projects

      # (ì„ íƒ) ê²°ê³¼ë¥¼ Snyk ëŒ€ì‹œë³´ë“œì— ì—…ë¡œë“œ
      - name: Run Snyk monitor (optional)
        if: always()
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          snyk monitor --all-projects

  sonarcloud_scan:
    name: Run SonarCloud SAST Scan (gate)
    needs: snyk_scan
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew build -x test

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v3
        continue-on-error: true
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
            -Dsonar.organization=${{ secrets.SONAR_ORG }}
            -Dsonar.projectName=${{ secrets.SONAR_PROJECT_NAME }}
            -Dsonar.sources=src
            -Dsonar.java.binaries=build/classes
            -Dsonar.host.url=https://sonarcloud.io
            -Dsonar.scanner.force-deprecated-java-version=true

      # (ì„ íƒ) "í’ˆì§ˆê²Œì´íŠ¸"ë¥¼ í™•ì‹¤íˆ job failë¡œ ë°˜ì˜í•˜ê³  ì‹¶ìœ¼ë©´ ì•„ë˜ë¥¼ ì¶”ê°€ ê³ ë ¤
      # - SonarCloud í”„ë¡œì íŠ¸ì—ì„œ Quality Gateê°€ ë¸Œëœì¹˜ì— ê°•ì œë˜ë„ë¡ ì„¤ì •í•˜ëŠ” ê²Œ ì¼ë°˜ì ì…ë‹ˆë‹¤.

  docker_build_and_push:
    name: Build and Push Docker Image
    needs: sonarcloud_scan
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build JAR with Gradle
        run: ./gradlew clean bootJar -x test

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }} # ê¶Œì¥: Docker Hub Access Token

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
            ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  trivy_scan:
    name: Run Trivy Image Scan (gate + report + slack)
    needs: docker_build_and_push
    runs-on: ubuntu-latest
    steps:
      - name: Set image reference
        run: |
          echo "IMAGE_REF=${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}" >> $GITHUB_ENV

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Pull image
        run: docker pull "${IMAGE_REF}"

      - name: Download Trivy HTML Template
        run: |
          mkdir -p .trivy
          curl -sSfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/html.tpl -o .trivy/html.tpl

      # 1) HTML ë¦¬í¬íŠ¸(í•­ìƒ ìƒì„±, ì‹¤íŒ¨ ì•ˆ í•¨)
      - name: Trivy report (HTML)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.IMAGE_REF }}
          format: template
          template: "@.trivy/html.tpl"
          output: trivy-report.html
          exit-code: "0"
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH"

      - name: Upload Trivy Report as Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report
          path: trivy-report.html

      # 2) Slackìš© JSON ìƒì„±(í•­ìƒ, ì‹¤íŒ¨ ì•ˆ í•¨)
      - name: Trivy scan (JSON for Slack)
        if: always()
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.IMAGE_REF }}
          format: json
          output: trivy-result.json
          exit-code: "0"
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH"

      # 3) Slack ì•Œë¦¼(í•­ìƒ)
      - name: Send Trivy CVE summary to Slack
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          IMAGE_REF: ${{ env.IMAGE_REF }}
          GITHUB_REPO: ${{ github.repository }}
          GITHUB_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq

          SUMMARY=$(jq -r '
            [
              .Results[]?
              | .Vulnerabilities[]?
              | select(.Severity=="CRITICAL" or .Severity=="HIGH")
              | "- \(.Severity) \(.VulnerabilityID) | \(.PkgName) \(.InstalledVersion) -> \(.FixedVersion // "unfixed")"
            ]
            | unique
            | .[0:25]
            | join("\n")
          ' trivy-result.json)

          if [ -z "$SUMMARY" ] || [ "$SUMMARY" = "null" ]; then
            TEXT="âœ… Trivy: CRITICAL/HIGH ì—†ìŒ\nâ€¢ Image: ${IMAGE_REF}\nâ€¢ Run: ${GITHUB_RUN_URL}"
          else
            TEXT="ğŸš¨ Trivy ë°œê²¬ (CRITICAL/HIGH)\nâ€¢ Repo: ${GITHUB_REPO}\nâ€¢ Image: ${IMAGE_REF}\nâ€¢ Run: ${GITHUB_RUN_URL}\n\n${SUMMARY}"
          fi

          jq -n --arg text "$TEXT" '{text:$text}' \
            | curl -sSf -X POST -H 'Content-type: application/json' --data @- "$SLACK_WEBHOOK_URL"

      # 4) ê²Œì´íŠ¸ëŠ” ë§¨ ë§ˆì§€ë§‰(ì—¬ê¸°ì„œ ì‹¤íŒ¨í•´ë„ Slackì€ ì´ë¯¸ ë³´ëƒ„)
      - name: Trivy gate (fail on CRITICAL/HIGH)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.IMAGE_REF }}
          format: table
          exit-code: "1"
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH"

      - name: Show Report Summary
        if: always()
        run: |
          echo "## Trivy Scan Report" >> "$GITHUB_STEP_SUMMARY"
          echo "Artifactë¡œ trivy-report.html ì—…ë¡œë“œ ì™„ë£Œ" >> "$GITHUB_STEP_SUMMARY"
          echo "- Image: $IMAGE_REF" >> "$GITHUB_STEP_SUMMARY"


  deploy:
    name: Deploy to EC2 (Docker Run)
    needs: trivy_scan
    runs-on: ubuntu-latest
    steps:
      - name: Set environment variables
        run: |
          echo "IMAGE_REF=${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}" >> $GITHUB_ENV
          echo "CONTAINER_NAME=${{ env.IMAGE_NAME }}" >> $GITHUB_ENV
      - name: Set up SSH Key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > /tmp/id_rsa
          chmod 600 /tmp/id_rsa

      # âœ… ë³´ì•ˆ ê°•í™”: í™˜ê²½ ë³€ìˆ˜ë¥¼ íŒŒì¼ë¡œ ì „ë‹¬í•˜ì—¬ ëª…ë ¹ì¤„ ë…¸ì¶œ ë°©ì§€
      - name: Deploy via SSH
        env:
          EC2_HOST: ${{ secrets.EC2_PUBLIC_IP }}
          EC2_USER: ${{ secrets.EC2_SSH_USER }} # ì˜ˆ: ec2-user ë˜ëŠ” ubuntu
          DOCKER_USER: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASS: ${{ secrets.DOCKER_PASSWORD }}
          IMAGE_REF: ${{ env.IMAGE_REF }}
          CONTAINER_NAME: ${{ env.CONTAINER_NAME }}
          # í™˜ê²½ ë³€ìˆ˜ë“¤
          DB1_URL: ${{ secrets.DB1_URL }}
          DB1_USERNAME: ${{ secrets.DB1_USERNAME }}
          DB1_PASSWORD: ${{ secrets.DB1_PASSWORD }}
          DB_DRIVER: ${{ secrets.DB_DRIVER }}
          REDIS_URL: ${{ secrets.REDIS_URL }}
          REDIS_PORT: ${{ secrets.REDIS_PORT }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
          JWT: ${{ secrets.JWT }}
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
          S3_ACCESS_KEY: ${{ secrets.S3_ACCESS_KEY }}
          S3_SECRET_KEY: ${{ secrets.S3_SECRET_KEY }}
          S3_CLIENT: ${{ secrets.S3_CLIENT }}
          S3_REGION: ${{ secrets.S3_REGION }}
          GOOGLE_MAIL: ${{ secrets.GOOGLE_MAIL }}
          GOOGLE_APP_PASSWORD: ${{ secrets.GOOGLE_APP_PASSWORD }}
          FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_PROJECT_ID: ${{ secrets.GEMINI_PROJECT_ID }}
          GEMINI_MODEL: ${{ secrets.GEMINI_MODEL }}
          GEMINI_TEMPERATURE: ${{ secrets.GEMINI_TEMPERATURE }}
          QWEN_API_URL: ${{ secrets.QWEN_API_URL }}
          QWEN_API_KEY: ${{ secrets.QWEN_API_KEY }}
          QWEN_MODEL: ${{ secrets.QWEN_MODEL }}
          QWEN_TEMPERATURE: ${{ secrets.QWEN_TEMPERATURE }}
          LLM_TIMEOUT: ${{ secrets.LLM_TIMEOUT }}
          LLM_MAX_RETRIES: ${{ secrets.LLM_MAX_RETRIES }}
          DB_CONNECTION_TIMEOUT: ${{ secrets.DB_CONNECTION_TIMEOUT }}
          DB_MAX_POOL_SIZE: ${{ secrets.DB_MAX_POOL_SIZE }}
          DB_MIN_IDLE: ${{ secrets.DB_MIN_IDLE }}
          DB_MAX_LIFETIME: ${{ secrets.DB_MAX_LIFETIME }}
          DB_IDLE_TIMEOUT: ${{ secrets.DB_IDLE_TIMEOUT }}
          DB_LEAK_DETECTION_THRESHOLD: ${{ secrets.DB_LEAK_DETECTION_THRESHOLD }}
          DB_POOL_NAME: ${{ secrets.DB_POOL_NAME }}
          REDIS_TIMEOUT: ${{ secrets.REDIS_TIMEOUT }}
          REDIS_CONNECT_TIMEOUT: ${{ secrets.REDIS_CONNECT_TIMEOUT }}
          MAIL_HOST: ${{ secrets.MAIL_HOST }}
          MAIL_PORT: ${{ secrets.MAIL_PORT }}
          MAIL_SMTP_AUTH: ${{ secrets.MAIL_SMTP_AUTH }}
          MAIL_SMTP_STARTTLS_ENABLE: ${{ secrets.MAIL_SMTP_STARTTLS_ENABLE }}
          MAIL_SMTP_STARTTLS_REQUIRED: ${{ secrets.MAIL_SMTP_STARTTLS_REQUIRED }}
          MAX_FILE_SIZE: ${{ secrets.MAX_FILE_SIZE }}
          MAX_REQUEST_SIZE: ${{ secrets.MAX_REQUEST_SIZE }}
          APP_LATEST_VERSION: ${{ secrets.APP_LATEST_VERSION }}
          FIREBASE_CONFIG_PATH: ${{ secrets.FIREBASE_CONFIG_PATH }}
        run: |
          # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„± (ë³´ì•ˆ: ëª…ë ¹ì¤„ ë…¸ì¶œ ë°©ì§€)
          # ì‘ì€ë”°ì˜´í‘œ ì—†ì´ ì‚¬ìš©í•˜ì—¬ ë³€ìˆ˜ í™•ì¥ í—ˆìš©
          cat > /tmp/docker.env << ENVFILE
          DB1_URL=${DB1_URL}
          DB1_USERNAME=${DB1_USERNAME}
          DB1_PASSWORD=${DB1_PASSWORD}
          DB_DRIVER=${DB_DRIVER}
          SPRING_DATA_REDIS_HOST=${REDIS_URL}
          SPRING_DATA_REDIS_PORT=${REDIS_PORT}
          REDIS_URL=${REDIS_URL}
          REDIS_PORT=${REDIS_PORT}
          REDIS_PASSWORD=${REDIS_PASSWORD}
          JWT=${JWT}
          S3_BUCKET=${S3_BUCKET}
          S3_ACCESS_KEY=${S3_ACCESS_KEY}
          S3_SECRET_KEY=${S3_SECRET_KEY}
          S3_CLIENT=${S3_CLIENT}
          S3_REGION=${S3_REGION}
          GOOGLE_MAIL=${GOOGLE_MAIL}
          GOOGLE_APP_PASSWORD=${GOOGLE_APP_PASSWORD}
          FRONTEND_URL=${FRONTEND_URL}
          GEMINI_API_KEY=${GEMINI_API_KEY}
          GEMINI_PROJECT_ID=${GEMINI_PROJECT_ID}
          GEMINI_MODEL=${GEMINI_MODEL}
          GEMINI_TEMPERATURE=${GEMINI_TEMPERATURE}
          QWEN_API_URL=${QWEN_API_URL}
          QWEN_API_KEY=${QWEN_API_KEY}
          QWEN_MODEL=${QWEN_MODEL}
          QWEN_TEMPERATURE=${QWEN_TEMPERATURE}
          LLM_TIMEOUT=${LLM_TIMEOUT}
          LLM_MAX_RETRIES=${LLM_MAX_RETRIES}
          DB_CONNECTION_TIMEOUT=${DB_CONNECTION_TIMEOUT}
          DB_MAX_POOL_SIZE=${DB_MAX_POOL_SIZE}
          DB_MIN_IDLE=${DB_MIN_IDLE}
          DB_MAX_LIFETIME=${DB_MAX_LIFETIME}
          DB_IDLE_TIMEOUT=${DB_IDLE_TIMEOUT}
          DB_LEAK_DETECTION_THRESHOLD=${DB_LEAK_DETECTION_THRESHOLD}
          DB_POOL_NAME=${DB_POOL_NAME}
          REDIS_TIMEOUT=${REDIS_TIMEOUT}
          REDIS_CONNECT_TIMEOUT=${REDIS_CONNECT_TIMEOUT}
          MAIL_HOST=${MAIL_HOST}
          MAIL_PORT=${MAIL_PORT}
          MAIL_SMTP_AUTH=${MAIL_SMTP_AUTH}
          MAIL_SMTP_STARTTLS_ENABLE=${MAIL_SMTP_STARTTLS_ENABLE}
          MAIL_SMTP_STARTTLS_REQUIRED=${MAIL_SMTP_STARTTLS_REQUIRED}
          MAX_FILE_SIZE=${MAX_FILE_SIZE}
          MAX_REQUEST_SIZE=${MAX_REQUEST_SIZE}
          APP_LATEST_VERSION=${APP_LATEST_VERSION}
          FIREBASE_CONFIG_PATH=${FIREBASE_CONFIG_PATH}
          ENVFILE

          # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ì„ EC2ë¡œ ì „ì†¡
          scp -o StrictHostKeyChecking=no -i /tmp/id_rsa /tmp/docker.env ${EC2_USER}@${EC2_HOST}:/tmp/docker.env

          # SSHë¡œ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          ssh -o StrictHostKeyChecking=no -i /tmp/id_rsa ${EC2_USER}@${EC2_HOST} \
          "IMAGE_REF='${IMAGE_REF}' CONTAINER_NAME='${CONTAINER_NAME}' DOCKER_USER='${DOCKER_USER}' DOCKER_PASS='${DOCKER_PASS}' bash -s" << 'EOF'
            set -euo pipefail

            # Docker ì—†ìœ¼ë©´ ì„¤ì¹˜(ìµœì†Œ)
            if ! command -v docker >/dev/null 2>&1; then
              if command -v yum >/dev/null 2>&1; then
                sudo yum -y install docker || (sudo amazon-linux-extras install docker -y)
                sudo systemctl enable docker
                sudo systemctl start docker
              elif command -v apt-get >/dev/null 2>&1; then
                sudo apt-get update -y
                sudo apt-get install -y docker.io
                sudo systemctl enable docker
                sudo systemctl start docker
              fi
            fi

            sudo systemctl start docker || sudo service docker start || true

            echo "${DOCKER_PASS}" | sudo docker login -u "${DOCKER_USER}" --password-stdin

            sudo docker pull "${IMAGE_REF}"

            sudo docker stop "${CONTAINER_NAME}" 2>/dev/null || true
            sudo docker rm "${CONTAINER_NAME}" 2>/dev/null || true

            # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ì„ ì‚¬ìš©í•˜ì—¬ docker run (ë³´ì•ˆ ê°•í™”)
            # íŒŒì¼ ê¶Œí•œ ì„¤ì • (ì†Œìœ ìë§Œ ì½ê¸° ê°€ëŠ¥)
            chmod 600 /tmp/docker.env

            sudo docker run -d \
              -p 8080:8080 \
              --restart unless-stopped \
              --name "${CONTAINER_NAME}" \
              --env-file /tmp/docker.env \
              "${IMAGE_REF}"

            # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ì‚­ì œ (ë³´ì•ˆ)
            rm -f /tmp/docker.env

            sudo docker image prune -f
          EOF

          # ë¡œì»¬ ì„ì‹œ íŒŒì¼ ì‚­ì œ
          rm -f /tmp/docker.env

  zap_scan:
    name: DAST with OWASP ZAP (report)
    needs: deploy
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write # ZAPì´ ì´ìŠˆ/ì½”ë©˜íŠ¸ ë‚¨ê¸¸ ë•Œ í•„ìš”. í•„ìš” ì—†ìœ¼ë©´ ì§€ì›Œë„ ë¨.
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # âœ… ë°°í¬ ì§í›„ ì•± ì¤€ë¹„ ëŒ€ê¸°(ìì£¼ ì‹¤íŒ¨í•˜ëŠ” ë¶€ë¶„ ë°©ì§€)
      - name: Wait for service to be ready
        env:
          TARGET: ${{ secrets.DEPLOY_TARGET_URL }} # ì˜ˆ: http://1.2.3.4/
        run: |
          set -euo pipefail
          echo "Waiting for: ${TARGET}"
          for i in {1..60}; do
            code="$(curl -s -o /dev/null -w "%{http_code}" "${TARGET}" || true)"
            if [ "$code" = "200" ] || [ "$code" = "301" ] || [ "$code" = "302" ]; then
              echo "Service is up (HTTP $code)"
              exit 0
            fi
            sleep 5
          done
          echo "Service did not become ready in time."
          exit 1

      - name: ZAP Full Scan
        uses: zaproxy/action-full-scan@v0.12.0
        with:
          # ë³´í†µì€ GitHub í† í°ì´ë©´ ì¶©ë¶„ (PAT ê³¼ê¶Œí•œ ë°©ì§€)
          token: ${{ github.token }}
          docker_name: ghcr.io/zaproxy/zaproxy:stable
          target: ${{ secrets.DEPLOY_TARGET_URL }}
          rules_file_name: .zap/rules.tsv
          cmd_options: "-a"

      - name: Upload ZAP Report(s)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: |
            report_html.html
            report_json.json
            report_md.md
