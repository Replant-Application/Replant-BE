# ===========================================
# Replant Backend Application Configuration
# 모든 민감한 정보는 .env 파일에서 로드됩니다
# spring-dotenv 라이브러리 사용: ${env.변수명}
# ===========================================

server:
  port: ${env.SERVER_PORT:8080}
  timezone: ${env.SERVER_TIMEZONE:Asia/Seoul}

spring:
  application:
    name: Replant-BE

  # ===========================================
  # DataSource 설정 (MariaDB) - .env에서 로드
  # ===========================================
  datasource:
    secondary:
      jdbc-url: ${env.DB1_URL}
      username: ${env.DB1_USERNAME}
      password: ${env.DB1_PASSWORD}
      driver-class-name: ${env.DB_DRIVER:com.mysql.cj.jdbc.Driver}
      connection-timeout: ${env.DB_CONNECTION_TIMEOUT:30000}
      maximum-pool-size: ${env.DB_MAX_POOL_SIZE:10}
      minimum-idle: ${env.DB_MIN_IDLE:5}
      max-lifetime: ${env.DB_MAX_LIFETIME:1800000}
      idle-timeout: ${env.DB_IDLE_TIMEOUT:600000}
      leak-detection-threshold: ${env.DB_LEAK_DETECTION_THRESHOLD:60000}
      pool-name: ${env.DB_POOL_NAME:MariaDB-HikariPool}

  mvc:
    hiddenmethod:
      filter:
        enabled: true
    static-path-pattern: /files/**

  servlet:
    multipart:
      max-file-size: ${env.MAX_FILE_SIZE:10MB}
      max-request-size: ${env.MAX_REQUEST_SIZE:10MB}

  jackson:
    time-zone: Asia/Seoul
    serialization:
      write-dates-as-timestamps: false  # LocalDateTime을 ISO 8601 형식으로 직렬화

  jpa:
    hibernate:
      ddl-auto: update
    properties:
      hibernate:
        format_sql: true
        dialect: org.hibernate.dialect.MySQLDialect
        connection:
          characterEncoding: UTF-8
          useUnicode: true
    show-sql: true
    database-platform: org.hibernate.dialect.MySQLDialect

  # Flyway 비활성화 (마이그레이션 제거됨)
  flyway:
    enabled: false

  # ===========================================
  # Redis 설정 - .env에서 로드
  # ===========================================
  data:
    redis:
      host: ${env.REDIS_URL:localhost}
      port: ${env.REDIS_PORT:6379}
      password: ${env.REDIS_PASSWORD:}
      timeout: ${env.REDIS_TIMEOUT:2000ms}
      connect-timeout: ${env.REDIS_CONNECT_TIMEOUT:2000ms}

  # Redis 자동설정 오류 무시
  autoconfigure:
    exclude:
      - org.springframework.boot.actuate.autoconfigure.data.redis.RedisHealthContributorAutoConfiguration

  # Log 설정
  output:
    ansi:
      enabled: always

  # ===========================================
  # Mail 설정 (Gmail SMTP) - .env에서 로드
  # ===========================================
  mail:
    host: ${env.MAIL_HOST:smtp.gmail.com}
    port: ${env.MAIL_PORT:587}
    username: ${env.GOOGLE_MAIL}
    password: ${env.GOOGLE_APP_PASSWORD}
    properties:
      mail.smtp.auth: ${env.MAIL_SMTP_AUTH:true}
      mail.smtp.starttls.enable: ${env.MAIL_SMTP_STARTTLS_ENABLE:true}
      mail.smtp.starttls.required: ${env.MAIL_SMTP_STARTTLS_REQUIRED:true}

  # ===========================================
  # Spring AI - LLM 설정
  # 주의: spring-dotenv의 ${env.}가 여기서 작동하지 않으므로 시스템 환경변수 사용
  # ===========================================
  ai:
    # Google Gemini (Primary)
    # 주의: Spring AI가 project-id와 location을 필수로 체크하지만, API Key만 사용 시 실제로는 사용되지 않음
    google:
      genai:
        api-key: ${GEMINI_API_KEY:${env.GEMINI_API_KEY}}
        project-id: ${GEMINI_PROJECT_ID:${env.GEMINI_PROJECT_ID:replant-application}}
        location: ${GEMINI_LOCATION:${env.GEMINI_LOCATION:us-central1}}
        chat:
          options:
            model: ${GEMINI_MODEL:${env.GEMINI_MODEL:gemini-3-flash-preview}}
            temperature: ${env.GEMINI_TEMPERATURE:0.7}
    
    # OpenAI 호환 API - Qwen/vLLM (Fallback)
    # 주의: Spring AI가 자동으로 /v1을 추가하므로 base-url에 /v1 제외
    openai:
      base-url: ${QWEN_API_URL:${env.QWEN_API_URL}}
      api-key: ${QWEN_API_KEY:${env.QWEN_API_KEY:dummy}}
      chat:
        options:
          model: ${QWEN_MODEL:${env.QWEN_MODEL:Qwen/Qwen2.5-14B-Instruct-AWQ}}
          temperature: ${env.QWEN_TEMPERATURE:0.7}

# ===========================================
# JWT 설정 - .env에서 로드
# ===========================================
jwt:
  secret: ${env.JWT}

# ===========================================
# AWS S3 설정 - .env에서 로드
# ===========================================
aws:
  s3:
    bucket: ${env.S3_BUCKET:replant-bucket}
    accessKey: ${env.S3_ACCESS_KEY}
    secretKey: ${env.S3_SECRET_KEY}
    client: ${env.S3_CLIENT:cloud5-s3}
    region: ${env.S3_REGION:ap-northeast-2}

# ===========================================
# Frontend URL 설정 (CORS) - .env에서 로드
# ===========================================
frontend:
  url: ${env.FRONTEND_URL:http://localhost:8081}

# ===========================================
# 채팅 서비스 설정
# ===========================================
chat:
  llm:
    primary: gemini
    fallback: qwen
    timeout: ${env.LLM_TIMEOUT:30000}
    max-retries: ${env.LLM_MAX_RETRIES:2}
  prompt:
    max-length: ${env.CHAT_PROMPT_MAX_LENGTH:15}
    max-length-unit: ${env.CHAT_PROMPT_MAX_LENGTH_UNIT:글자}

# Swagger/OpenAPI 설정
springdoc:
  swagger-ui:
    path: ${env.SWAGGER_UI_PATH:/swagger-ui.html}
    tags-sorter: alpha
    operations-sorter: alpha
  api-docs:
    path: ${env.API_DOCS_PATH:/v3/api-docs}
  default-consumes-media-type: application/json

# Actuator 설정
management:
  endpoints:
    web:
      exposure:
        include: ${env.ACTUATOR_ENDPOINTS:health,info,metrics}
      base-path: ${env.ACTUATOR_BASE_PATH:/actuator}
  endpoint:
    health:
      show-details: ${env.ACTUATOR_HEALTH_SHOW_DETAILS:when-authorized}
      roles: ${env.ACTUATOR_HEALTH_ROLES:ADMIN}
