# ===========================================
# Replant Backend Application Configuration
# 모든 민감???보??.env ?일?서 로드?니??
# spring-dotenv ?이브러??용: ${env.변?명}
# ===========================================

server:
  port: ${env.SERVER_PORT:8080}
  timezone: ${env.SERVER_TIMEZONE:Asia/Seoul}

spring:
  application:
    name: Replant-BE

  # ===========================================
  # DataSource ?정 (MariaDB) - .env?서 로드
  # ===========================================
  datasource:
    secondary:
      jdbc-url: ${env.DB1_URL}
      username: ${env.DB1_USERNAME}
      password: ${env.DB1_PASSWORD}
      driver-class-name: ${env.DB_DRIVER:com.mysql.cj.jdbc.Driver}
      connection-timeout: ${env.DB_CONNECTION_TIMEOUT:30000}
      maximum-pool-size: ${env.DB_MAX_POOL_SIZE:10}
      minimum-idle: ${env.DB_MIN_IDLE:5}
      max-lifetime: ${env.DB_MAX_LIFETIME:1800000}
      idle-timeout: ${env.DB_IDLE_TIMEOUT:600000}
      leak-detection-threshold: ${env.DB_LEAK_DETECTION_THRESHOLD:60000}
      pool-name: ${env.DB_POOL_NAME:MariaDB-HikariPool}

  mvc:
    hiddenmethod:
      filter:
        enabled: true
    static-path-pattern: /files/**

  servlet:
    multipart:
      max-file-size: ${env.MAX_FILE_SIZE:10MB}
      max-request-size: ${env.MAX_REQUEST_SIZE:10MB}

  jackson:
    time-zone: Asia/Seoul
    serialization:
      write-dates-as-timestamps: false  # LocalDateTime??ISO 8601 ?식?로 직렬??

  jpa:
    hibernate:
      ddl-auto: update
    properties:
      hibernate:
        format_sql: true
        dialect: org.hibernate.dialect.MySQLDialect
        connection:
          characterEncoding: UTF-8
          useUnicode: true
    show-sql: true
    database-platform: org.hibernate.dialect.MySQLDialect

  # Flyway 비활?화 (마이그레?션 ?거??
  flyway:
    enabled: false

  # ===========================================
  # Redis ?정 - .env?서 로드
  # ===========================================
  data:
    redis:
      host: ${env.REDIS_URL:localhost}
      port: ${env.REDIS_PORT:6379}
      password: ${env.REDIS_PASSWORD:}
      timeout: ${env.REDIS_TIMEOUT:2000ms}
      connect-timeout: ${env.REDIS_CONNECT_TIMEOUT:2000ms}

  # Redis ?동?정 ?류 무시
  autoconfigure:
    exclude:
      - org.springframework.boot.actuate.autoconfigure.data.redis.RedisHealthContributorAutoConfiguration

  # Log ?정
  output:
    ansi:
      enabled: always

  # ===========================================
  # Mail ?정 (Gmail SMTP) - .env?서 로드
  # ===========================================
  mail:
    host: ${env.MAIL_HOST:smtp.gmail.com}
    port: ${env.MAIL_PORT:587}
    username: ${env.GOOGLE_MAIL}
    password: ${env.GOOGLE_APP_PASSWORD}
    properties:
      mail.smtp.auth: ${env.MAIL_SMTP_AUTH:true}
      mail.smtp.starttls.enable: ${env.MAIL_SMTP_STARTTLS_ENABLE:true}
      mail.smtp.starttls.required: ${env.MAIL_SMTP_STARTTLS_REQUIRED:true}

  # ===========================================
  # Spring AI - LLM ?정
  # 주의: spring-dotenv??${env.}가 ?기???동?? ?으므??스???경변???용
  # ===========================================
  ai:
    model:
      embedding: transformers
    # Google Gemini (Primary) - API Key??용
    # 주의: Spring AI가 project-id? location???수?체크????정 ?요
    # api-key가 ?정?어 ?으?API Key 모드??작 (credentials 불필??
    google:
      genai:
        api-key: ${GEMINI_API_KEY:${env.GEMINI_API_KEY:dummy-api-key}}
        project-id: ${GEMINI_PROJECT_ID:${env.GEMINI_PROJECT_ID:replant-application}}
        # location? Spring AI가 ?수??구??(기본? us-central1)
        location: ${GEMINI_LOCATION:${env.GEMINI_LOCATION:us-central1}}
        chat:
          options:
            model: ${GEMINI_MODEL:${env.GEMINI_MODEL:gemini-3-flash-preview}}
            temperature: ${env.GEMINI_TEMPERATURE:0.7}
    
    # OpenAI ?환 API - Qwen/vLLM (Fallback)
    # 주의: Spring AI가 ?동?로 /v1??추????base-url??/v1 ?외
    openai:
      base-url: ${QWEN_API_URL:${env.QWEN_API_URL:http://localhost:8000}}
      api-key: ${QWEN_API_KEY:${env.QWEN_API_KEY:dummy}}
      chat:
        options:
          model: ${QWEN_MODEL:${env.QWEN_MODEL:Qwen/Qwen2.5-14B-Instruct-AWQ}}
          temperature: ${env.QWEN_TEMPERATURE:0.7}

    # Embedding - Transformers (ONNX)
    embedding:
      transformer:
        onnx:
          model-uri: ${env.EMBEDDING_MODEL_ONNX_URI:https://huggingface.co/intfloat/multilingual-e5-small/resolve/main/onnx/model.onnx}
        tokenizer:
          uri: ${env.EMBEDDING_TOKENIZER_URI:https://huggingface.co/intfloat/multilingual-e5-small/resolve/main/tokenizer.json}
        token: ${env.HF_TOKEN:}
        cache:
          enabled: true

    # Vector Store - Qdrant (gRPC)
    vectorstore:
      qdrant:
        host: ${env.QDRANT_HOST:localhost}
        port: ${env.QDRANT_GRPC_PORT:6334}
        collection-name: ${env.QDRANT_COLLECTION:user_memory}

# ===========================================
# JWT ?정 - .env ?는 ?스???경변?에??로드
# ===========================================
jwt:
  secret: ${JWT:${env.JWT:}}

# ===========================================
# AWS S3 ?정 - .env?서 로드
# ===========================================
aws:
  s3:
    bucket: ${env.S3_BUCKET:replant-bucket}
    accessKey: ${env.S3_ACCESS_KEY}
    secretKey: ${env.S3_SECRET_KEY}
    client: ${env.S3_CLIENT:cloud5-s3}
    region: ${env.S3_REGION:ap-northeast-2}

# ===========================================
# Frontend URL ?정 (CORS) - .env?서 로드
# ===========================================
frontend:
  url: ${env.FRONTEND_URL:http://localhost:8081}

# ===========================================
# 채팅 ?비???정
# ===========================================
chat:
  llm:
    primary: gemini
    fallback: qwen
    timeout: ${env.LLM_TIMEOUT:30000}
    max-retries: ${env.LLM_MAX_RETRIES:2}
  prompt:
    max-length: ${env.CHAT_PROMPT_MAX_LENGTH:15}
    max-length-unit: ${env.CHAT_PROMPT_MAX_LENGTH_UNIT:??}
  rag:
    top-k: ${env.CHAT_RAG_TOP_K:4}
    max-chars: ${env.CHAT_RAG_MAX_CHARS:800}

# Swagger/OpenAPI ?정
springdoc:
  swagger-ui:
    path: ${env.SWAGGER_UI_PATH:/swagger-ui.html}
    tags-sorter: alpha
    operations-sorter: alpha
  api-docs:
    path: ${env.API_DOCS_PATH:/v3/api-docs}
  default-consumes-media-type: application/json

# Actuator ?정
management:
  endpoints:
    web:
      exposure:
        include: ${env.ACTUATOR_ENDPOINTS:health,info,metrics,prometheus}
      base-path: ${env.ACTUATOR_BASE_PATH:/actuator}
  endpoint:
    health:
      show-details: ${env.ACTUATOR_HEALTH_SHOW_DETAILS:when-authorized}
      roles: ${env.ACTUATOR_HEALTH_ROLES:ADMIN}
  metrics:
    export:
      prometheus:
        enabled: true

# ===========================================
# One-time RAG Sync (Startup)
# ===========================================
rag:
  sync:
    once: ${env.RAG_SYNC_ONCE:false}
    limit: ${env.RAG_SYNC_LIMIT:0}

